# 前端异常监控系统

## 前言
维护一个可用性有极高要求的站点，如何在第一时间发现线上的前端异常？

## 一：前端异常监控系统的构建目标

在对监控页面无侵入的前提下，提供7*24小时全天候的监控任务，第一时间发现“裸奔”、“半裸奔”页面或有Javascript异常抛出的页面，并给网站前端负责人提供短信、邮件等方式的报警服务。

可以说，前端异常监控系统主要解决两大异常情况：a 页面上有Javascript异常 b 各种因素造成的页面的样式丢失。以下是针对于以下两种异常的解决思路：

## 二：Javascript的异常监控

对于客户端浏览器环境不同，在开发环境中能够工作的代码，并非就能在用户的电脑上正常运行，各种畸形浏览器造成的问题弄的我们头很大，如何能够像后端开发那样随时查看服务器端错误日志就好了！

Javascript语言自身就提供了try catch的异常处理，我们假以利用的话，就能够在增强前端应用鲁棒性的同时，又可以把捕获到的异常抛送给前端异常监控系统，以错误日志的形式记录在数据库中。

给应用添加异常处理功能，我们可以充分发挥JavaScript这一动态语言的优势。不需要在代码中加N多个try-catch语句。例：通过JavaScript类模块在应用中注册的时候，遍历类模块中的每一个函数，然后统一加上try-catch处理，这样前端里面的所有函数就都在异常处理的范围之内了。

![image-20220311135001106](https://cdn.jsdelivr.net/gh/hjc0826/map-depot@main/uPic/2022-03-11 13:50:01 image-20220311135001106.png)

有了以上的全局异常处理函数之后，解决线上的JavaScript异常就是小菜一碟，只需要定义好错误message的格式，并在catch语句中向异常监控系统的固定接口中发送数据即可。我们可以在错误消息中发送关于错误的浏览器信息，js模块信息，函数信息，或具体错误消息等，要传送哪些信息全看你自己的需要。在FdSafe异常监控系统中，我们传输了如下错误的信息：![image-20220311135246351](https://cdn.jsdelivr.net/gh/hjc0826/map-depot@main/uPic/2022-03-11 13:52:46 image-20220311135246351.png)

### 三：样式丢失的异常监控

如果你的页面在不该裸奔的时候突然裸奔了，那就是严重的可用性问题，需要前端同学在第一时间定位问题并迅速修复。引发“裸奔”的可能性有很多，也许是CSS文件404了，也许是CSS@import url的问题，但是最终的表象只有一个，那就是页面样式突然发生极大改变。

在FdSafe系统中，我们使用了图片对比的方法来探测线上页面发生“裸奔”的现象，原理上很简单：对于被监控页面的URL，我们让监控系统保留其前一天页面被浏览器渲染的截图，然后让监控系统周期性的定时抓取线上的页面，两张图片做**相似度对比**，如果相似度差值超过了一定的阀值，则出发报警条件。

页面的截图我们是使用QT的webkit内核渲染并截取的，当然也推荐使用selenium的浏览器截图功能。而图片相似度的算法很多，我们最终采用的是OpenCV中的cvCompareHist算法。

### 四：其他的异常监控

除了样式丢失及javascript异常之外，前端还是有很多其它异常可以通过系统来监控的，比如说JS、CSS文件的404错误，HTML源码的闭合异常，或JS、CSS文件的压缩异常等。fdSafe系统能够通过添加插件的方式来提供对不同异常的监控，然后统一汇总到异常日志中。

### 五：页面总体架构图

> 搭建前端的异常监控系统

1. 定时抓取被监控页面的HTML远吗，并分析存在页面样式丢失异常或者其他异常
2. 接受来自用户浏览器发送的JavaScript异常

一旦发生异常，且超出设定的允许阀值，则触发报警条件，给负责人发送报警消息，系统原理图如下：![image-20220311144711644](https://cdn.jsdelivr.net/gh/hjc0826/map-depot@main/uPic/2022-03-11 14:47:12 image-20220311144711644.png)





